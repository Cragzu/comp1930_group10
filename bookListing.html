<!DOCTYPE html>
<html lang="en">

<head>
    <title>StudySource | Book Listing</title>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.4.1/css/bootstrap.min.css" integrity="sha384-Vkoo8x4CGsO3+Hhxv8T/Q5PaXtkKtu6ug5TOeNV6gBiFeWPGFN9MuhOf23Q9Ifjh" crossorigin="anonymous">
    <link rel="stylesheet" href="style/stylesheet.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">

    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.4.1/jquery.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.7/umd/popper.min.js"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.3.1/js/bootstrap.min.js"></script>

    <!-- The core Firebase JS SDK is always required and must be listed first -->
    <script src="https://www.gstatic.com/firebasejs/7.2.3/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/7.2.2/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/7.2.3/firebase-firestore.js"></script>

    <script src="scripts/firebase_setup.js"></script>
</head>

<body>
    <script src="scripts/displayHeader.js"></script>
    <!--Header should always be displayed first-->

    <div class="centerContainer">
        <div class="innerTextContainer">

            <div class="inlineContainer">
                <h2 id="bookTitle">[Book Title]</h2>
                <h2 id="bookAuthor">[Author Name]</h2>
            </div>

            <img class="bookImageListingPage" src="images/bookPlaceholder.jpg" />
            <h1 id="price">Price: $placeholder</h1>

            <h3 id="seller">Seller: [Seller Name]</h3>

            <p id="bookDescription">
                [Description of the book]
            </p>

            <div class="listingButtonContainer">
                <a href="shoppingCart.html">
                    <button type="button" class="btn btn-primary">View my Cart</button>
                </a>
                <!-- <a href="underConstruction.html"> -->
                    <button type="button" class="btn btn-primary" id="addToCart">Add to Cart</button>
                <!-- </a> -->
            </div>

        </div>
    </div>

    <script>
        const docId = localStorage.getItem("docId");
        const userDisplayName = localStorage.getItem("userDisplayName");
        let cartIndex;
        let sameId;

        function getCurrentData() {

            let bookTitle = document.getElementById("bookTitle");
            let bookAuthor = document.getElementById("bookAuthor");
            let bookDesc = document.getElementById("bookDescription");
            let bookSeller = document.getElementById("seller");
            let bookPrice = document.getElementById("price");

            db.collection("books").doc(`${docId}`).onSnapshot(function (doc) {
                // Try to access the data if the docId change is working.

                console.log(doc.data());
                bookTitle.innerHTML = doc.data().Title;
                bookAuthor.innerHTML = `&nbsp;by ${doc.data().Author}`;
                bookDesc.innerHTML = `Description: ${doc.data().Description}`;
                bookSeller.innerHTML = `Seller: ${doc.data().Seller}`;
                bookPrice.innerHTML = `Price: &#36;${doc.data().Price}`;

            })
        }
        function bookIteration() {
            cartIndex = 1;
            // Set the index at one so the first book that is listed will be called "book1"
            sameId = false;


            db.collection("users").doc(userDisplayName).collection("cart").get()
                .then(function (querySnapshot) {
                    querySnapshot.forEach(function (doc) {

                        // doc.data() is never undefined for query doc snapshots
                        if (doc.id === "book" + pad(cartIndex, 5)) {

                            if (doc.data().bookId === docId) {

                                sameId = true;
                            }

                            // If we find a book with the same name then we increase our index again.
                            // It will keep going until it hits the non existing document
                            // After that the cartIndex will stay the same number and we will make a new doucment with the current cartIndex. When adding to a cart the ways books are given ids is that it will always start with book1 and and gaps in number will be filled in.
                            cartIndex += 1;

                        }

                    });
                    addBookToCart();
                });

        }

        function pad(n, width, z) {
            // This function will allow the index to be consistent with the firebase.
            // If I do pad(1, 5) I will get 00001 back.
            // The only purpose of this function is to help sort the cart in Firebase.
            z = z || '0';
            n = n + '';
            return n.length >= width ? n : new Array(width - n.length + 1).join(z) + n;
        }


        function addBookToCart() {
            // This function is supposed to add books to the logged in user cart
            if (sameId !== true) {
                db.collection("users").doc(userDisplayName).collection("cart").doc("book" + pad(cartIndex, 5)).set({

                    bookId: docId,
                }).then(function () {
                    alert(`The book has been added to your cart!`)

                }).catch(function () {
                    console.log(`We tried adding the book to the cart, but something has caused it to fail.`)
                })
            } else {
                alert(`You already added this book to your cart! Please view your cart to see it.`)
            }
        }



        function init() {
            // Run the functions in this script.
            firebase.auth().onAuthStateChanged(function (user) {
                if (user) {
                    console.log(`There is a user logged in. User: ${user.displayName}`);

                } else {
                    console.log(`No one is logged in`);

                }
            });
            getCurrentData();
            document.getElementById("addToCart").onclick = bookIteration;
        }

        init();
    </script>

</body>

</html>