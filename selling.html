<!DOCTYPE html>
<html lang="en">

<head>
    <title>StudySource | Selling Product</title>
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css">
    <link rel="stylesheet" href="style/stylesheet.css">
</head>

<body>
    <script src="scripts/displayHeader.js"></script> <!--Header should always be at the top of the body-->
    <h1> Selling </h1>
    <h4> Selling the textbooks </h4>

    <div id="bookSellingForm">
        <form>
            <div>
                <label for="bookTitle">
                    Title of Book:
                </label>
                <input type="text" id="bookTitle" name="book_title"
                    placeholder="E.g. Writing In the Technical Fields 2nd Edition">
            </div>
            <div>
                <label for="author">
                    Author:
                </label>
                <input type="text" id="authorName" name="author_name" placeholder="Thorsten Ewald">
            </div>
            <div>
                <label for="bookPrice">
                    Price(CAD):
                </label>
                <input type="text" id="bookPrice" name="book_price" placeholder="50.50">
            </div>
            <div>
                <label for="bookDescription">
                    Description:
                </label>
                  <textarea id="bookDescription" name="book_desc" class="form-control md-textarea" length="50" rows="5"></textarea>

            </div>
            <div>
                <input type="button" id="listButton" value="Post Listing">
            </div>
        </form>
    </div>

    <script src="https://www.gstatic.com/firebasejs/7.2.3/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/7.2.2/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/7.2.3/firebase-firestore.js"></script>

    <script src="scripts/firebase_setup.js"></script>

    <script>
        let userStatus;

        function listBook(author, title, price, description, seller) {

            console.log("This is the start of listing a book.");

            db.collection("books").add({
                Author: author,
                Title: title,
                Price: price,
                Description: description,
                Seller: db.doc("users/" + seller)
                
            }).then(function () {
                console.log("A book had been successfully listed.")
            }).catch(function () {
                console.log("User has failed trying to list a book.")
            })
        }

        function checkTextBox() {
            // This function will check all the text boxes first before you can list a book
            let bookTitle = document.getElementById("bookTitle").value;
            let authorName = document.getElementById("authorName").value;
            let bookPrice = document.getElementById("bookPrice").value;
            let bookDescription = document.getElementById("bookDescription").value;
            let user = firebase.auth().currentUser;
            let userDisplay = user.displayName;
            console.log('Desc is:', bookDescription);

            if (bookTitle && !(/\d/.test(authorName)) && !isNaN(bookPrice) && bookDescription) {
                /*
                The conditions check is:
                1. Check if something is filled in for title
                2. Check if author name is only letters; this will automatically fail if nothing is filled in
                3. Check if the price entered is a number; this will automatically fail if nothing is filled in
                    - isNaN: 50 = false; !isNan: 50 = true
                4. If there is ANYTHING typed in the book description section it will pass
                */
                console.log("The user passed all the fields");
                // Once all the conditions are passed we can then give all of out data to the listBook function
                //This will take all of the data inputted and give it to the database
                listBook(authorName, bookTitle, bookPrice, bookDescription, userDisplay);
            }
            else {
                alert("At least one of the four fields has not been entered");
            }
        }

        function init() {
            firebase.auth().onAuthStateChanged(function (user) {
                if (user) {
                    console.log(`There is a user logged in. User: ${user}`);
                    userStatus = true
                } else {
                    console.log(`No one is logged in`);
                    userStatus = false
                }
            })
            document.getElementById("listButton").onclick = checkTextBox;
        // When you click the button it will check the fields before you can list the book.

        }

        init();

    </script>
</body>

</html>